{% extends "layout/basic.html" %}
{% import "components/contest.html" as contest with context %}
{% block content %}
<style>
  .tempuser-displayname-form {
    display: inline;
  }
  .tempuser-displayname-input {
    display: inline-block;
    width: 200px;
    margin: 0;
    padding: 2px;
  }
  .password-cell {
    font-family: monospace;
    cursor: pointer;
  }
  .password-hidden {
    color: #999;
  }
  .pagination {
    text-align: center;
    margin: 20px 0;
  }
  .pagination a, .pagination span {
    display: inline-block;
    padding: 5px 10px;
    margin: 0 2px;
    border: 1px solid #ddd;
    text-decoration: none;
  }
  .pagination a:hover {
    background: #f0f0f0;
  }
  .pagination .current {
    background: #0078d7;
    color: white;
    border-color: #0078d7;
  }
  .bulk-actions {
    margin: 20px 0;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 5px;
  }
</style>
<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('Temp Users for Contest: ') }}{{ tdoc['title'] }}</h1>
      </div>
      <div class="section__body">
        <div class="row">
          <div class="columns">
            <a href="{{ reverse_url('contest_tempuser_import', tid=tdoc['doc_id']) }}" class="button">{{ _('Import from CSV') }}</a>
            <a href="{{ reverse_url('contest_tempuser_export', tid=tdoc['doc_id']) }}" class="button">{{ _('Export to CSV with Passwords') }}</a>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('Add New Temp User') }}</h1>
      </div>
      <div class="section__body">
        <form method="post" action="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id']) }}?operation=add">
          <input type="hidden" name="csrf_token" value="{{ handler.csrf_token }}">
          <div class="row">
            <div class="columns">
              <label>
                {{ _('Display Name') }}
                <input type="text" name="display_name" required placeholder="{{ _('Enter full name or display name') }}">
              </label>
              <p class="help-text">{{ _('Username and email will be generated automatically from the display name') }}</p>
            </div>
          </div>
          <div class="row">
            <div class="columns">
              <button type="submit" class="expanded button">{{ _('Add Temp User') }}</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('Existing Temp Users') }} ({{ total_count }})</h1>
      </div>
      
      <div class="bulk-actions">
        <button class="button primary" onclick="syncAll()">
          <i class="icon icon-refresh"></i> {{ _('Sync All to Real Users') }}
        </button>
        <p class="help-text">{{ _('This will create real user accounts for all temp users and make them contest attendees') }}</p>
      </div>
      
      <div class="section__body no-padding">
        {% if temp_users %}
        <table class="data-table">
          <thead>
            <tr>
              <th>{{ _('Display Name') }}</th>
              <th>{{ _('Username') }}</th>
              <th>{{ _('Email') }}</th>
              <th>{{ _('Password') }}</th>
              <th>{{ _('Synced') }}</th>
              <th>{{ _('UID') }}</th>
              <th>{{ _('Actions') }}</th>
            </tr>
          </thead>
          <tbody>
          {% for temp_user in temp_users %}
            <tr>
              <td>
                <form method="post" action="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id']) }}?operation=edit" class="tempuser-displayname-form">
                  <input type="hidden" name="csrf_token" value="{{ handler.csrf_token }}">
                  <input type="hidden" name="temp_user_id" value="{{ temp_user['_id'] }}">
                  <input type="text" name="display_name" value="{{ temp_user.get('display_name', '') }}" class="tempuser-displayname-input">
                  <button type="submit" class="button tiny">{{ _('Update') }}</button>
                </form>
              </td>
              <td><code>{{ temp_user['uname'] }}</code></td>
              <td><code>{{ temp_user.get('email', '') }}</code></td>
              <td>
                <span class="password-cell password-hidden" id="pwd-{{ temp_user['_id'] }}" onclick="togglePassword('{{ temp_user['_id'] }}')">
                  <span class="password-value" data-******>••••••••</span>
                </span>
                <button class="button tiny" onclick="regeneratePassword('{{ temp_user['_id'] }}')">
                  {{ _('Regenerate') }}
                </button>
              </td>
              <td>
                {% if temp_user.get('synced', False) %}
                  <span class="label success">{{ _('Yes') }}</span>
                {% else %}
                  <span class="label secondary">{{ _('No') }}</span>
                {% endif %}
              </td>
              <td>{{ temp_user.get('synced_uid', '-') }}</td>
              <td>
                <form method="post" action="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id']) }}?operation=delete" class="tempuser-displayname-form" onsubmit="return confirm('{{ _('Are you sure? This will delete the temp user, real user account, and attendance.') }}');">
                  <input type="hidden" name="csrf_token" value="{{ handler.csrf_token }}">
                  <input type="hidden" name="temp_user_id" value="{{ temp_user['_id'] }}">
                  <button type="submit" class="button tiny alert">{{ _('Delete') }}</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        
        {% if total_pages > 1 %}
        <div class="pagination">
          {% if page > 1 %}
            <a href="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id'], page=1) }}">{{ _('First') }}</a>
            <a href="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id'], page=page-1) }}">{{ _('Previous') }}</a>
          {% endif %}
          
          {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
            {% if p == page %}
              <span class="current">{{ p }}</span>
            {% else %}
              <a href="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id'], page=p) }}">{{ p }}</a>
            {% endif %}
          {% endfor %}
          
          {% if page < total_pages %}
            <a href="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id'], page=page+1) }}">{{ _('Next') }}</a>
            <a href="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id'], page=total_pages) }}">{{ _('Last') }}</a>
          {% endif %}
        </div>
        {% endif %}
        
        {% else %}
        <div class="section__body typo">
          <p>{{ _('No temp users yet.') }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="medium-3 columns">
  {% with owner_udoc=udict.get(tdoc['owner_uid'], {}), owner_dudoc=dudict.get(tdoc['owner_uid'], {}) %}
    {% include "partials/contest_sidebar.html" %}
  {% endwith %}
  </div>
</div>

<script>
function togglePassword(userId) {
  var cell = document.getElementById('pwd-' + userId);
  var valueSpan = cell.querySelector('.password-value');
  var password = valueSpan.getAttribute('data-password');
  
  if (cell.classList.contains('password-hidden')) {
    valueSpan.textContent = password;
    cell.classList.remove('password-hidden');
  } else {
    valueSpan.textContent = '••••••••';
    cell.classList.add('password-hidden');
  }
}

function regeneratePassword(userId) {
  if (!confirm('{{ _("Are you sure you want to regenerate the password?") }}')) {
    return;
  }
  
  var formData = new FormData();
  formData.append('csrf_token', '{{ handler.csrf_token }}');
  formData.append('temp_user_id', userId);
  
  fetch('{{ reverse_url("contest_tempuser", tid=tdoc["doc_id"]) }}?operation=regenerate_password', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      var cell = document.getElementById('pwd-' + userId);
      var valueSpan = cell.querySelector('.password-value');
      valueSpan.setAttribute('data-password', data.password);
      valueSpan.textContent = data.password;
      cell.classList.remove('password-hidden');
      alert('{{ _("Password regenerated successfully!") }}');
    } else {
      alert('{{ _("Error regenerating password") }}');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('{{ _("Error regenerating password") }}');
  });
}

function syncAll() {
  if (!confirm('{{ _("Are you sure you want to sync all unsynced temp users? This will create real user accounts and make them contest attendees.") }}')) {
    return;
  }
  
  var formData = new FormData();
  formData.append('csrf_token', '{{ handler.csrf_token }}');
  
  fetch('{{ reverse_url("contest_tempuser", tid=tdoc["doc_id"]) }}?operation=sync_all', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      var msg = '{{ _("Successfully synced") }} ' + data.synced_count + ' {{ _("temp users") }}';
      if (data.errors && data.errors.length > 0) {
        msg += '\n\n{{ _("Errors:") }}\n' + data.errors.join('\n');
      }
      alert(msg);
      location.reload();
    } else {
      alert('{{ _("Error syncing users") }}');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('{{ _("Error syncing users") }}');
  });
}
</script>
{% endblock %}
