{% extends "layout/basic.html" %}
{% import "components/contest.html" as contest with context %}
{% block content %}
<style>
  .tempuser-displayname-form {
    display: inline;
  }
  .tempuser-displayname-input {
    display: inline-block;
    width: 200px;
    margin: 0;
    padding: 2px;
  }
  .password-cell {
    font-family: monospace;
    cursor: pointer;
  }
  .password-hidden {
    color: #999;
  }
  .sync-dialog {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    z-index: 1001;
    min-width: 400px;
  }
  .sync-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
  }
</style>
<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('Temp Users for Contest: ') }}{{ tdoc['title'] }}</h1>
      </div>
      <div class="section__body">
        <div class="row">
          <div class="columns">
            <a href="{{ reverse_url('contest_tempuser_import', tid=tdoc['doc_id']) }}" class="button">{{ _('Import from CSV') }}</a>
            <a href="{{ reverse_url('contest_tempuser_export', tid=tdoc['doc_id']) }}" class="button">{{ _('Export to CSV with Passwords') }}</a>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('Add New Temp User') }}</h1>
      </div>
      <div class="section__body">
        <form method="post" action="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id']) }}?operation=add">
          <input type="hidden" name="csrf_token" value="{{ handler.csrf_token }}">
          <div class="row">
            <div class="columns">
              <label>
                {{ _('Display Name') }}
                <input type="text" name="display_name" required placeholder="{{ _('Enter full name or display name') }}">
              </label>
              <p class="help-text">{{ _('Username and email will be generated automatically from the display name') }}</p>
            </div>
          </div>
          <div class="row">
            <div class="columns">
              <button type="submit" class="expanded button">{{ _('Add Temp User') }}</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="section">
      <div class="section__header">
        <h1 class="section__title">{{ _('Existing Temp Users') }}</h1>
      </div>
      <div class="section__body no-padding">
        {% if temp_users %}
        <table class="data-table">
          <thead>
            <tr>
              <th>{{ _('Display Name') }}</th>
              <th>{{ _('Username') }}</th>
              <th>{{ _('Email') }}</th>
              <th>{{ _('Password') }}</th>
              <th>{{ _('Synced') }}</th>
              <th>{{ _('Actions') }}</th>
            </tr>
          </thead>
          <tbody>
          {% for temp_user in temp_users %}
            <tr>
              <td>
                <form method="post" action="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id']) }}?operation=edit" class="tempuser-displayname-form">
                  <input type="hidden" name="csrf_token" value="{{ handler.csrf_token }}">
                  <input type="hidden" name="temp_user_id" value="{{ temp_user['_id'] }}">
                  <input type="text" name="display_name" value="{{ temp_user.get('display_name', '') }}" class="tempuser-displayname-input">
                  <button type="submit" class="button tiny">{{ _('Update') }}</button>
                </form>
              </td>
              <td><code>{{ temp_user['uname'] }}</code></td>
              <td><code>{{ temp_user.get('email', '') }}</code></td>
              <td>
                <span class="password-cell password-hidden" id="pwd-{{ temp_user['_id'] }}" onclick="togglePassword('{{ temp_user['_id'] }}')">
                  <span class="password-value" data-password="{{ temp_user.get('password', '') }}">••••••••</span>
                </span>
                <button class="button tiny" onclick="regeneratePassword('{{ temp_user['_id'] }}')">
                  {{ _('Regenerate') }}
                </button>
              </td>
              <td>{{ _('Yes') if temp_user.get('synced', False) else _('No') }}</td>
              <td>
                {% if not temp_user.get('synced', False) %}
                <button class="button tiny" onclick="showSyncDialog('{{ temp_user['_id'] }}', '{{ temp_user['uname'] }}', '{{ temp_user.get('email', '') }}')">
                  {{ _('Sync to User') }}
                </button>
                <form method="post" action="{{ reverse_url('contest_tempuser', tid=tdoc['doc_id']) }}?operation=delete" class="tempuser-displayname-form" onsubmit="return confirm('{{ _('Are you sure?') }}');">
                  <input type="hidden" name="csrf_token" value="{{ handler.csrf_token }}">
                  <input type="hidden" name="temp_user_id" value="{{ temp_user['_id'] }}">
                  <button type="submit" class="button tiny alert">{{ _('Delete') }}</button>
                </form>
                {% else %}
                <span class="label success">{{ _('Synced: ') }}{{ temp_user.get('synced_uid', '') }}</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="section__body typo">
          <p>{{ _('No temp users yet.') }}</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="medium-3 columns">
  {% with owner_udoc=udict.get(tdoc['owner_uid'], {}), owner_dudoc=dudict.get(tdoc['owner_uid'], {}) %}
    {% include "partials/contest_sidebar.html" %}
  {% endwith %}
  </div>
</div>

<!-- Sync Dialog -->
<div id="syncOverlay" class="sync-overlay" onclick="closeSyncDialog()"></div>
<div id="syncDialog" class="sync-dialog">
  <h3>{{ _('Sync Temp User to Real User') }}</h3>
  <form id="syncForm">
    <input type="hidden" name="csrf_token" value="{{ handler.csrf_token }}">
    <input type="hidden" id="syncTempUserId" name="temp_user_id">
    
    <div style="margin-bottom: 15px;">
      <label>
        <strong>{{ _('Username') }}:</strong>
        <input type="text" id="syncUsername" readonly style="background: #f5f5f5; width: 100%;">
      </label>
    </div>
    
    <div style="margin-bottom: 15px;">
      <label>
        <strong>{{ _('Email') }}:</strong>
        <input type="text" id="syncEmail" readonly style="background: #f5f5f5; width: 100%;">
      </label>
    </div>
    
    <div style="margin-bottom: 15px;">
      <label>
        <strong>{{ _('User ID (UID)') }}:</strong>
        <input type="number" name="uid" id="syncUid" required style="width: 100%;">
      </label>
      <p class="help-text">{{ _('Enter the numeric user ID to sync this temp user to') }}</p>
    </div>
    
    <div>
      <button type="submit" class="button">{{ _('Sync User') }}</button>
      <button type="button" class="button secondary" onclick="closeSyncDialog()">{{ _('Cancel') }}</button>
    </div>
    
    <div id="syncResult" style="display: none; margin-top: 15px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 3px;">
      <strong>{{ _('Success!') }}</strong><br>
      {{ _('User synced successfully. Password:') }} <code id="syncPassword"></code>
    </div>
  </form>
</div>

<script>
function togglePassword(userId) {
  var cell = document.getElementById('pwd-' + userId);
  var valueSpan = cell.querySelector('.password-value');
  var password = valueSpan.getAttribute('data-password');
  
  if (cell.classList.contains('password-hidden')) {
    valueSpan.textContent = password;
    cell.classList.remove('password-hidden');
  } else {
    valueSpan.textContent = '••••••••';
    cell.classList.add('password-hidden');
  }
}

function regeneratePassword(userId) {
  if (!confirm('{{ _("Are you sure you want to regenerate the password?") }}')) {
    return;
  }
  
  var formData = new FormData();
  formData.append('csrf_token', '{{ handler.csrf_token }}');
  formData.append('temp_user_id', userId);
  
  fetch('{{ reverse_url("contest_tempuser", tid=tdoc["doc_id"]) }}?operation=regenerate_password', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      var cell = document.getElementById('pwd-' + userId);
      var valueSpan = cell.querySelector('.password-value');
      valueSpan.setAttribute('data-password', data.password);
      valueSpan.textContent = data.password;
      cell.classList.remove('password-hidden');
      alert('{{ _("Password regenerated successfully!") }}');
    } else {
      alert('{{ _("Error regenerating password") }}');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('{{ _("Error regenerating password") }}');
  });
}

function showSyncDialog(tempUserId, username, email) {
  document.getElementById('syncTempUserId').value = tempUserId;
  document.getElementById('syncUsername').value = username;
  document.getElementById('syncEmail').value = email;
  document.getElementById('syncUid').value = '';
  document.getElementById('syncResult').style.display = 'none';
  document.getElementById('syncDialog').style.display = 'block';
  document.getElementById('syncOverlay').style.display = 'block';
}

function closeSyncDialog() {
  document.getElementById('syncDialog').style.display = 'none';
  document.getElementById('syncOverlay').style.display = 'none';
}

document.getElementById('syncForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  var formData = new FormData(this);
  
  fetch('{{ reverse_url("contest_tempuser", tid=tdoc["doc_id"]) }}?operation=sync', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.getElementById('syncPassword').textContent = data.password;
      document.getElementById('syncResult').style.display = 'block';
      setTimeout(function() {
        location.reload();
      }, 3000);
    } else {
      alert('{{ _("Error syncing user") }}');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('{{ _("Error syncing user") }}');
  });
});
</script>
{% endblock %}
